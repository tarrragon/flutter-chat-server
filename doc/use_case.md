# 概述

本文檔描述了 Flutter 聊天室 WebSocket 服務器的業務需求和核心事件，定義系統應該提供的功能和行為。

---

## 核心業務事件

### E001: 用戶身份驗證

用戶嘗試連接聊天室時需要提供有效的用戶名稱和密碼進行身份驗證。

### E002: 帳號資訊查詢  

系統提供可用測試帳號的查詢功能，讓客戶端了解可登入的帳號和對應頻道。

### E003: WebSocket 即時訊息傳送

已認證用戶可透過 WebSocket 連接即時發送和接收訊息。

### E004: REST API 訊息發送

系統提供 REST API 端點供外部系統發送訊息到聊天室。

### E005: 歷史訊息載入

用戶連接到頻道時可載入該頻道的歷史訊息記錄。

### E006: 頻道隔離管理

不同頻道的用戶和訊息完全隔離，確保訊息只在指定頻道內傳播。

### E007: 用戶狀態通知

系統在用戶加入或離開頻道時自動發送通知訊息給該頻道的其他用戶。

### E008: 在線用戶查詢

系統提供查詢目前在線用戶的功能，按頻道分組顯示。

### E009: 錯誤處理和回應

系統對無效請求、認證失敗、連接異常等情況提供適當的錯誤處理和回應。

### E010: 併發處理能力

系統能同時處理多個用戶連接、訊息發送和頻道操作，維持系統穩定性。

---

## 系統架構需求

### 多頻道支援

- 系統預設支援三個獨立頻道：general、tech、random
- 每個測試帳號綁定特定頻道
- 頻道間完全隔離，無法跨頻道通訊

### 雙重通訊協議

- **WebSocket**: 提供即時雙向通訊
- **REST API**: 提供標準 HTTP 介面

### 訊息持久化

- 所有訊息按頻道分類儲存
- 支援歷史訊息查詢
- 系統訊息（加入/離開通知）也納入歷史記錄

### 用戶管理

- 基於預設帳號的簡單認證機制
- 每個連接綁定特定用戶和頻道
- 即時用戶狀態追蹤

---

## API 端點定義

### WebSocket 端點

- `ws://host:port/ws?username={用戶名}&password={密碼}`

### REST API 端點

- `GET /api/messages?channel={頻道}` - 獲取歷史訊息
- `POST /api/messages` - 發送訊息
- `GET /api/users` - 獲取在線用戶
- `GET /api/accounts` - 獲取可用帳號
- `POST /api/login` - 驗證帳號登入

---

## 預設測試帳號

系統預設提供三個測試帳號：

| 用戶名 | 密碼 | 頻道 |
|--------|------|------|
| alice | password123 | general |
| bob | password123 | tech |
| charlie | password123 | random |

---

## 訊息格式標準

### 基本訊息結構

```json
{
  "id": "唯一識別碼",
  "user": "用戶名稱", 
  "content": "訊息內容",
  "timestamp": "時間戳記",
  "type": "訊息類型", 
  "channel": "頻道名稱"
}
```

### 訊息類型
- `text`: 一般文字訊息
- `system`: 系統通知訊息

---

## 系統行為定義

### 連接建立時

1. 驗證用戶憑證
2. 建立 WebSocket 連接
3. 發送用戶加入通知
4. 註冊到對應頻道

### 訊息處理時  

1. 接收並驗證訊息格式
2. 儲存訊息到頻道記錄
3. 廣播給該頻道所有在線用戶
4. 記錄處理日誌

### 連接斷開時

1. 清理連接資源
2. 發送用戶離開通知
3. 從頻道用戶清單移除

### 錯誤處理時

1. 記錄錯誤日誌
2. 返回適當錯誤訊息
3. 維持系統穩定運行

---

## 總結

此聊天室系統的核心價值在於提供一個簡單、穩定、多頻道隔離的即時通訊平台，支援 WebSocket 和 REST API 雙重介面，滿足不同客戶端的接入需求。
