<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šå¸³è™ŸèŠå¤©å®¤æ¸¬è©¦</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>ğŸš€ å¤šå¸³è™ŸèŠå¤©å®¤æ¸¬è©¦</h1>
        
        <!-- ç™»å…¥é¸æ“‡å€åŸŸ -->
        <div id="loginSection" class="login-section">
            <h3>é¸æ“‡æ¸¬è©¦å¸³è™Ÿç™»å…¥ï¼š</h3>
            <div id="accountSelector" class="account-selector">
                <!-- å¸³è™Ÿé¸é …å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
            <div style="margin-top: 15px;">
                <button id="connectButton" class="btn-primary" onclick="connectWithAccount()" disabled>
                    é€£æ¥èŠå¤©å®¤
                </button>
                <button class="btn-secondary" onclick="refreshAccounts()">
                    é‡æ–°è¼‰å…¥å¸³è™Ÿ
                </button>
            </div>
        </div>

        <!-- èŠå¤©å€åŸŸ -->
        <div id="chatSection" class="chat-section">
            <div class="chat-header">
                <div class="channel-info">
                    <span>ğŸ‘¤ <span id="currentUser"></span></span>
                    <span class="channel-badge" id="currentChannel"></span>
                </div>
                <button class="btn-danger" onclick="disconnect()">ç™»å‡º</button>
            </div>

            <div id="status" class="status"></div>
            <div id="onlineUsers" class="online-users" style="display: none;"></div>
            <div id="messages" class="messages"></div>
            
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯..." disabled>
                <button id="sendButton" class="btn-primary" onclick="sendMessage()" disabled>ç™¼é€</button>
            </div>

            <div class="controls">
                <button class="btn-secondary" onclick="loadMessages()">è¼‰å…¥æ­·å²è¨Šæ¯</button>
                <button class="btn-secondary" onclick="getOnlineUsers()">æŸ¥çœ‹åœ¨ç·šç”¨æˆ¶</button>
                <button class="btn-secondary" onclick="toggleDebug()">åˆ‡æ›é™¤éŒ¯æ¨¡å¼</button>
            </div>

            <div id="debug" class="debug" style="display: none;"></div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let ws = null;
        let currentAccount = null;
        let selectedAccount = null;
        let debugMode = false;
        let accounts = [];

        // DOM å…ƒç´ 
        const loginSection = document.getElementById('loginSection');
        const chatSection = document.getElementById('chatSection');
        const accountSelector = document.getElementById('accountSelector');
        const connectButton = document.getElementById('connectButton');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const statusDiv = document.getElementById('status');
        const debugDiv = document.getElementById('debug');
        const sendButton = document.getElementById('sendButton');
        const currentUserSpan = document.getElementById('currentUser');
        const currentChannelSpan = document.getElementById('currentChannel');
        const onlineUsersDiv = document.getElementById('onlineUsers');

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = function() {
            refreshAccounts();
        };

        // è¼‰å…¥å¯ç”¨å¸³è™Ÿ
        function refreshAccounts() {
            showDebug('é–‹å§‹è¼‰å…¥å¯ç”¨å¸³è™Ÿ');
            fetch('/api/accounts')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    accounts = data.accounts;
                    renderAccountSelector();
                    showDebug('æˆåŠŸè¼‰å…¥ ' + accounts.length + ' å€‹å¸³è™Ÿ');
                })
                .catch(error => {
                    showStatus('âŒ è¼‰å…¥å¸³è™Ÿå¤±æ•—: ' + error.message, 'error');
                    showDebug('è¼‰å…¥å¸³è™ŸéŒ¯èª¤: ' + error.message);
                });
        }

        // æ¸²æŸ“å¸³è™Ÿé¸æ“‡å™¨
        function renderAccountSelector() {
            accountSelector.innerHTML = '';
            accounts.forEach(account => {
                const card = document.createElement('div');
                card.className = 'account-card';
                card.onclick = () => selectAccount(account);
                card.innerHTML = `
                    <div class="username">${account.username}</div>
                    <div class="channel">ğŸ“¡ ${account.channel}</div>
                    <div style="font-size: 10px; color: #999; margin-top: 5px;">å¯†ç¢¼: password123</div>
                `;
                card.dataset.username = account.username;
                accountSelector.appendChild(card);
            });
        }

        // é¸æ“‡å¸³è™Ÿ
        function selectAccount(account) {
            // ç§»é™¤ä¹‹å‰çš„é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.account-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // è¨­ç½®æ–°çš„é¸ä¸­ç‹€æ…‹
            const selectedCard = document.querySelector(`[data-username="${account.username}"]`);
            selectedCard.classList.add('selected');
            
            selectedAccount = account;
            connectButton.disabled = false;
            showDebug('é¸æ“‡å¸³è™Ÿ: ' + account.username + ' (é »é“: ' + account.channel + ')');
        }

        // é€£æ¥åˆ°èŠå¤©å®¤
        function connectWithAccount() {
            if (!selectedAccount) {
                showStatus('âŒ è«‹å…ˆé¸æ“‡ä¸€å€‹å¸³è™Ÿ', 'error');
                return;
            }

            const username = selectedAccount.username;
            const password = 'password123';
            
            showStatus('ğŸ”— æ­£åœ¨é€£æ¥...', 'loading');
            showDebug(`å˜—è©¦é€£æ¥: ${username} / ${password}`);

            // å‰µå»º WebSocket é€£æ¥
            const wsUrl = `ws://localhost:8080/ws?username=${username}&password=${password}`;
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                currentAccount = selectedAccount;
                currentUserSpan.textContent = currentAccount.username;
                currentChannelSpan.textContent = currentAccount.channel;
                
                loginSection.style.display = 'none';
                chatSection.style.display = 'block';
                
                messageInput.disabled = false;
                sendButton.disabled = false;
                
                showStatus('âœ… é€£æ¥æˆåŠŸï¼', 'success');
                showDebug('WebSocket é€£æ¥å·²å»ºç«‹');
                
                // è‡ªå‹•è¼‰å…¥è©²é »é“çš„æ­·å²è¨Šæ¯
                loadMessages();
            };

            ws.onclose = function(event) {
                showStatus('ğŸ”Œ é€£æ¥å·²é—œé–‰', 'error');
                showDebug('WebSocket é€£æ¥å·²é—œé–‰: ' + event.code + ' - ' + event.reason);
                
                messageInput.disabled = true;
                sendButton.disabled = true;
            };

            ws.onerror = function(error) {
                showStatus('âŒ é€£æ¥éŒ¯èª¤', 'error');
                showDebug('WebSocket éŒ¯èª¤: ' + error);
            };

            ws.onmessage = function(event) {
                showDebug('æ”¶åˆ° WebSocket è¨Šæ¯: ' + event.data);
                try {
                    const message = JSON.parse(event.data);
                    if (message.error) {
                        showStatus('âŒ æœå‹™å™¨éŒ¯èª¤: ' + message.error, 'error');
                        disconnect();
                    } else {
                        showDebug(`è§£æè¨Šæ¯æˆåŠŸ: ç”¨æˆ¶=${message.user}, é »é“=${message.channel}, å…§å®¹=${message.content}`);
                        addMessageToUI(message, 'websocket');
                        showStatus('ğŸ’¬ æ”¶åˆ°æ–°è¨Šæ¯', 'success');
                    }
                } catch (e) {
                    showDebug('è¨Šæ¯è§£æéŒ¯èª¤: ' + e.message + ', åŸå§‹è³‡æ–™: ' + event.data);
                }
            };
        }

        // ç™»å‡º
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
            
            currentAccount = null;
            loginSection.style.display = 'block';
            chatSection.style.display = 'none';
            
            // æ¸…é™¤é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.account-card').forEach(card => {
                card.classList.remove('selected');
            });
            selectedAccount = null;
            connectButton.disabled = true;
            
            showStatus('ğŸ‘‹ å·²ç™»å‡º', 'success');
            showDebug('å·²ç™»å‡º');
        }

        // ç™¼é€è¨Šæ¯
        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !currentAccount) return;

            // æª¢æŸ¥ WebSocket é€£æ¥ç‹€æ…‹
            showDebug(`WebSocket ç‹€æ…‹: ${ws ? ws.readyState : 'null'} (0=é€£æ¥ä¸­, 1=å·²é€£æ¥, 2=é—œé–‰ä¸­, 3=å·²é—œé–‰)`);
            showDebug(`ç•¶å‰å¸³è™Ÿ: ${currentAccount.username}, é »é“: ${currentAccount.channel}`);

            sendButton.disabled = true;
            sendButton.textContent = 'ç™¼é€ä¸­...';
            showStatus('ğŸ“¤ æ­£åœ¨ç™¼é€è¨Šæ¯...', 'loading');
            showDebug('é–‹å§‹ç™¼é€è¨Šæ¯: ' + content);

            messageInput.value = '';

            const requestBody = JSON.stringify({ 
                content: content,
                type: 'text',
                channel: currentAccount.channel,
                user: currentAccount.username
            });
            
            showDebug('ç™¼é€çš„è«‹æ±‚å…§å®¹: ' + requestBody);

            fetch('/api/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: requestBody
            })
            .then(response => {
                showDebug('ç™¼é€å›æ‡‰ï¼Œç‹€æ…‹ç¢¼: ' + response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'sent') {
                    showStatus('âœ… è¨Šæ¯ç™¼é€æˆåŠŸï¼', 'success');
                    showDebug('API å›æ‡‰æˆåŠŸ: ' + JSON.stringify(data));
                } else {
                    showStatus('âŒ ç™¼é€å¤±æ•—: ' + JSON.stringify(data), 'error');
                }
            })
            .catch(error => {
                showStatus('âŒ ç™¼é€å¤±æ•—: ' + error.message, 'error');
                showDebug('ç™¼é€éŒ¯èª¤: ' + error.message);
            })
            .finally(() => {
                sendButton.disabled = false;
                sendButton.textContent = 'ç™¼é€';
            });
        }

        // è¼‰å…¥æ­·å²è¨Šæ¯
        function loadMessages() {
            if (!currentAccount) return;
            
            showDebug('é–‹å§‹è¼‰å…¥é »é“ ' + currentAccount.channel + ' çš„æ­·å²è¨Šæ¯');
            fetch(`/api/messages?channel=${currentAccount.channel}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(messages => {
                    messagesDiv.innerHTML = '';
                    messages.forEach(msg => {
                        addMessageToUI(msg, 'history');
                    });
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    showStatus(`âœ… å·²è¼‰å…¥ ${messages.length} æ¢æ­·å²è¨Šæ¯`, 'success');
                    showDebug('æˆåŠŸè¼‰å…¥ ' + messages.length + ' æ¢è¨Šæ¯');
                })
                .catch(error => {
                    showStatus('âŒ è¼‰å…¥è¨Šæ¯å¤±æ•—: ' + error.message, 'error');
                    showDebug('è¼‰å…¥éŒ¯èª¤: ' + error.message);
                });
        }

        // å–å¾—åœ¨ç·šç”¨æˆ¶
        function getOnlineUsers() {
            showDebug('é–‹å§‹æŸ¥è©¢åœ¨ç·šç”¨æˆ¶');
            fetch('/api/users')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayOnlineUsers(data);
                    showDebug('åœ¨ç·šç”¨æˆ¶æŸ¥è©¢æˆåŠŸ: ' + JSON.stringify(data));
                })
                .catch(error => {
                    showStatus('âŒ å–å¾—ç”¨æˆ¶å¤±æ•—: ' + error.message, 'error');
                    showDebug('ç”¨æˆ¶æŸ¥è©¢éŒ¯èª¤: ' + error.message);
                });
        }

        // é¡¯ç¤ºåœ¨ç·šç”¨æˆ¶
        function displayOnlineUsers(data) {
            const channelUsers = data.channelUsers;
            const totalCount = data.totalCount;
            
            let html = `<h4>ğŸ“Š åœ¨ç·šç”¨æˆ¶ (ç¸½è¨ˆ: ${totalCount} äºº)</h4>`;
            
            for (const [channel, users] of Object.entries(channelUsers)) {
                html += `
                    <div class="channel-users">
                        <span class="channel-name">ğŸ“¡ ${channel}:</span>
                        <span class="user-list">${users.join(', ')} (${users.length} äºº)</span>
                    </div>
                `;
            }
            
            onlineUsersDiv.innerHTML = html;
            onlineUsersDiv.style.display = 'block';
            
            showStatus(`âœ… æŸ¥è©¢å®Œæˆ - å…± ${totalCount} äººåœ¨ç·š`, 'success');
        }

        // æ·»åŠ è¨Šæ¯åˆ° UI
        function addMessageToUI(message, source) {
            const messageElement = document.createElement('div');
            let className = 'message';
            
            if (message.type === 'system') {
                className += ' system';
            } else if (currentAccount && message.user === currentAccount.username) {
                className += ' own';
            }
            
            messageElement.className = className;
            
            const time = new Date(message.timestamp).toLocaleTimeString();
            const sourceLabel = source === 'websocket' ? 'ğŸ’¬ å³æ™‚' : 
                               source === 'history' ? 'ğŸ“š æ­·å²' : 'ğŸ”„ API';
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="message-user">${message.user}</span>
                    <div>
                        <span class="message-time">${time}</span>
                        <span class="message-source">${sourceLabel}</span>
                    </div>
                </div>
                <div>${message.content}</div>
            `;
            
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            showDebug(`æ·»åŠ è¨Šæ¯: ${message.user} - ${message.content} (ä¾†æº: ${source})`);
        }

        // åˆ‡æ›é™¤éŒ¯æ¨¡å¼
        function toggleDebug() {
            debugMode = !debugMode;
            debugDiv.style.display = debugMode ? 'block' : 'none';
            showDebug('é™¤éŒ¯æ¨¡å¼: ' + (debugMode ? 'é–‹å•Ÿ' : 'é—œé–‰'));
        }

        // é¡¯ç¤ºé™¤éŒ¯è¨Šæ¯
        function showDebug(message) {
            if (debugMode) {
                const timestamp = new Date().toLocaleTimeString();
                debugDiv.innerHTML += `[${timestamp}] ${message}<br>`;
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }

        // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            const timeout = type === 'success' ? 4000 : 3000;
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, timeout);
        }

        // éµç›¤äº‹ä»¶è™•ç†
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !sendButton.disabled) {
                sendMessage();
            }
        });
    </script>
</body>
</html>