<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多帳號聊天室測試</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>🚀 多帳號聊天室測試</h1>
        
        <!-- 登入選擇區域 -->
        <div id="loginSection" class="login-section">
            <h3>選擇測試帳號登入：</h3>
            <div id="accountSelector" class="account-selector">
                <!-- 帳號選項將由 JavaScript 動態生成 -->
            </div>
            <div style="margin-top: 15px;">
                <button id="connectButton" class="btn-primary" onclick="connectWithAccount()" disabled>
                    連接聊天室
                </button>
                <button class="btn-secondary" onclick="refreshAccounts()">
                    重新載入帳號
                </button>
            </div>
        </div>

        <!-- 聊天區域 -->
        <div id="chatSection" class="chat-section">
            <div class="chat-header">
                <div class="channel-info">
                    <span>👤 <span id="currentUser"></span></span>
                    <span class="channel-badge" id="currentChannel"></span>
                </div>
                <button class="btn-danger" onclick="disconnect()">登出</button>
            </div>

            <div id="status" class="status"></div>
            <div id="onlineUsers" class="online-users" style="display: none;"></div>
            <div id="messages" class="messages"></div>
            
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="輸入訊息..." disabled>
                <button id="sendButton" class="btn-primary" onclick="sendMessage()" disabled>發送</button>
            </div>

            <div class="controls">
                <button class="btn-secondary" onclick="loadMessages()">載入歷史訊息</button>
                <button class="btn-secondary" onclick="getOnlineUsers()">查看在線用戶</button>
                <button class="btn-secondary" onclick="toggleDebug()">切換除錯模式</button>
            </div>

            <div id="debug" class="debug" style="display: none;"></div>
        </div>
    </div>

    <script>
        // 全域變數
        let ws = null;
        let currentAccount = null;
        let selectedAccount = null;
        let debugMode = false;
        let accounts = [];

        // DOM 元素
        const loginSection = document.getElementById('loginSection');
        const chatSection = document.getElementById('chatSection');
        const accountSelector = document.getElementById('accountSelector');
        const connectButton = document.getElementById('connectButton');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const statusDiv = document.getElementById('status');
        const debugDiv = document.getElementById('debug');
        const sendButton = document.getElementById('sendButton');
        const currentUserSpan = document.getElementById('currentUser');
        const currentChannelSpan = document.getElementById('currentChannel');
        const onlineUsersDiv = document.getElementById('onlineUsers');

        // 頁面載入時初始化
        window.onload = function() {
            refreshAccounts();
        };

        // 載入可用帳號
        function refreshAccounts() {
            showDebug('開始載入可用帳號');
            fetch('/api/accounts')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    accounts = data.accounts;
                    renderAccountSelector();
                    showDebug('成功載入 ' + accounts.length + ' 個帳號');
                })
                .catch(error => {
                    showStatus('❌ 載入帳號失敗: ' + error.message, 'error');
                    showDebug('載入帳號錯誤: ' + error.message);
                });
        }

        // 渲染帳號選擇器
        function renderAccountSelector() {
            accountSelector.innerHTML = '';
            accounts.forEach(account => {
                const card = document.createElement('div');
                card.className = 'account-card';
                card.onclick = () => selectAccount(account);
                card.innerHTML = `
                    <div class="username">${account.username}</div>
                    <div class="channel">📡 ${account.channel}</div>
                    <div style="font-size: 10px; color: #999; margin-top: 5px;">密碼: password123</div>
                `;
                card.dataset.username = account.username;
                accountSelector.appendChild(card);
            });
        }

        // 選擇帳號
        function selectAccount(account) {
            // 移除之前的選中狀態
            document.querySelectorAll('.account-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // 設置新的選中狀態
            const selectedCard = document.querySelector(`[data-username="${account.username}"]`);
            selectedCard.classList.add('selected');
            
            selectedAccount = account;
            connectButton.disabled = false;
            showDebug('選擇帳號: ' + account.username + ' (頻道: ' + account.channel + ')');
        }

        // 連接到聊天室
        function connectWithAccount() {
            if (!selectedAccount) {
                showStatus('❌ 請先選擇一個帳號', 'error');
                return;
            }

            const username = selectedAccount.username;
            const password = 'password123';
            
            showStatus('🔗 正在連接...', 'loading');
            showDebug(`嘗試連接: ${username} / ${password}`);

            // 創建 WebSocket 連接
            const wsUrl = `ws://localhost:8080/ws?username=${username}&password=${password}`;
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                currentAccount = selectedAccount;
                currentUserSpan.textContent = currentAccount.username;
                currentChannelSpan.textContent = currentAccount.channel;
                
                loginSection.style.display = 'none';
                chatSection.style.display = 'block';
                
                messageInput.disabled = false;
                sendButton.disabled = false;
                
                showStatus('✅ 連接成功！', 'success');
                showDebug('WebSocket 連接已建立');
                
                // 自動載入該頻道的歷史訊息
                loadMessages();
            };

            ws.onclose = function(event) {
                showStatus('🔌 連接已關閉', 'error');
                showDebug('WebSocket 連接已關閉: ' + event.code + ' - ' + event.reason);
                
                messageInput.disabled = true;
                sendButton.disabled = true;
            };

            ws.onerror = function(error) {
                showStatus('❌ 連接錯誤', 'error');
                showDebug('WebSocket 錯誤: ' + error);
            };

            ws.onmessage = function(event) {
                showDebug('收到 WebSocket 訊息: ' + event.data);
                try {
                    const message = JSON.parse(event.data);
                    if (message.error) {
                        showStatus('❌ 服務器錯誤: ' + message.error, 'error');
                        disconnect();
                    } else {
                        showDebug(`解析訊息成功: 用戶=${message.user}, 頻道=${message.channel}, 內容=${message.content}`);
                        addMessageToUI(message, 'websocket');
                        showStatus('💬 收到新訊息', 'success');
                    }
                } catch (e) {
                    showDebug('訊息解析錯誤: ' + e.message + ', 原始資料: ' + event.data);
                }
            };
        }

        // 登出
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
            
            currentAccount = null;
            loginSection.style.display = 'block';
            chatSection.style.display = 'none';
            
            // 清除選中狀態
            document.querySelectorAll('.account-card').forEach(card => {
                card.classList.remove('selected');
            });
            selectedAccount = null;
            connectButton.disabled = true;
            
            showStatus('👋 已登出', 'success');
            showDebug('已登出');
        }

        // 發送訊息
        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !currentAccount) return;

            // 檢查 WebSocket 連接狀態
            showDebug(`WebSocket 狀態: ${ws ? ws.readyState : 'null'} (0=連接中, 1=已連接, 2=關閉中, 3=已關閉)`);
            showDebug(`當前帳號: ${currentAccount.username}, 頻道: ${currentAccount.channel}`);

            sendButton.disabled = true;
            sendButton.textContent = '發送中...';
            showStatus('📤 正在發送訊息...', 'loading');
            showDebug('開始發送訊息: ' + content);

            messageInput.value = '';

            const requestBody = JSON.stringify({ 
                content: content,
                type: 'text',
                channel: currentAccount.channel,
                user: currentAccount.username
            });
            
            showDebug('發送的請求內容: ' + requestBody);

            fetch('/api/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: requestBody
            })
            .then(response => {
                showDebug('發送回應，狀態碼: ' + response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'sent') {
                    showStatus('✅ 訊息發送成功！', 'success');
                    showDebug('API 回應成功: ' + JSON.stringify(data));
                } else {
                    showStatus('❌ 發送失敗: ' + JSON.stringify(data), 'error');
                }
            })
            .catch(error => {
                showStatus('❌ 發送失敗: ' + error.message, 'error');
                showDebug('發送錯誤: ' + error.message);
            })
            .finally(() => {
                sendButton.disabled = false;
                sendButton.textContent = '發送';
            });
        }

        // 載入歷史訊息
        function loadMessages() {
            if (!currentAccount) return;
            
            showDebug('開始載入頻道 ' + currentAccount.channel + ' 的歷史訊息');
            fetch(`/api/messages?channel=${currentAccount.channel}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(messages => {
                    messagesDiv.innerHTML = '';
                    messages.forEach(msg => {
                        addMessageToUI(msg, 'history');
                    });
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    showStatus(`✅ 已載入 ${messages.length} 條歷史訊息`, 'success');
                    showDebug('成功載入 ' + messages.length + ' 條訊息');
                })
                .catch(error => {
                    showStatus('❌ 載入訊息失敗: ' + error.message, 'error');
                    showDebug('載入錯誤: ' + error.message);
                });
        }

        // 取得在線用戶
        function getOnlineUsers() {
            showDebug('開始查詢在線用戶');
            fetch('/api/users')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayOnlineUsers(data);
                    showDebug('在線用戶查詢成功: ' + JSON.stringify(data));
                })
                .catch(error => {
                    showStatus('❌ 取得用戶失敗: ' + error.message, 'error');
                    showDebug('用戶查詢錯誤: ' + error.message);
                });
        }

        // 顯示在線用戶
        function displayOnlineUsers(data) {
            const channelUsers = data.channelUsers;
            const totalCount = data.totalCount;
            
            let html = `<h4>📊 在線用戶 (總計: ${totalCount} 人)</h4>`;
            
            for (const [channel, users] of Object.entries(channelUsers)) {
                html += `
                    <div class="channel-users">
                        <span class="channel-name">📡 ${channel}:</span>
                        <span class="user-list">${users.join(', ')} (${users.length} 人)</span>
                    </div>
                `;
            }
            
            onlineUsersDiv.innerHTML = html;
            onlineUsersDiv.style.display = 'block';
            
            showStatus(`✅ 查詢完成 - 共 ${totalCount} 人在線`, 'success');
        }

        // 添加訊息到 UI
        function addMessageToUI(message, source) {
            const messageElement = document.createElement('div');
            let className = 'message';
            
            if (message.type === 'system') {
                className += ' system';
            } else if (currentAccount && message.user === currentAccount.username) {
                className += ' own';
            }
            
            messageElement.className = className;
            
            const time = new Date(message.timestamp).toLocaleTimeString();
            const sourceLabel = source === 'websocket' ? '💬 即時' : 
                               source === 'history' ? '📚 歷史' : '🔄 API';
            
            messageElement.innerHTML = `
                <div class="message-header">
                    <span class="message-user">${message.user}</span>
                    <div>
                        <span class="message-time">${time}</span>
                        <span class="message-source">${sourceLabel}</span>
                    </div>
                </div>
                <div>${message.content}</div>
            `;
            
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            showDebug(`添加訊息: ${message.user} - ${message.content} (來源: ${source})`);
        }

        // 切換除錯模式
        function toggleDebug() {
            debugMode = !debugMode;
            debugDiv.style.display = debugMode ? 'block' : 'none';
            showDebug('除錯模式: ' + (debugMode ? '開啟' : '關閉'));
        }

        // 顯示除錯訊息
        function showDebug(message) {
            if (debugMode) {
                const timestamp = new Date().toLocaleTimeString();
                debugDiv.innerHTML += `[${timestamp}] ${message}<br>`;
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }

        // 顯示狀態訊息
        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            const timeout = type === 'success' ? 4000 : 3000;
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, timeout);
        }

        // 鍵盤事件處理
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !sendButton.disabled) {
                sendMessage();
            }
        });
    </script>
</body>
</html>