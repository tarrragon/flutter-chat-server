<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天室測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .messages { border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: 10px; margin: 10px 0; }
        .message { margin: 5px 0; padding: 5px; background: #f5f5f5; }
        .message.system { background: #e3f2fd; }
        .message.api { background: #f3e5f5; }
        .input-area { display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 10px; }
        button { padding: 10px 20px; }
        .status { margin: 10px 0; padding: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .loading { background: #fff3cd; color: #856404; }
        .debug { background: #f8f9fa; color: #495057; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>聊天室測試</h1>
        <div id="status" class="status" style="display: none;"></div>
        <div id="debug" class="debug" style="display: none;"></div>
        <div id="messages" class="messages"></div>
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="輸入訊息...">
            <button id="sendButton" onclick="sendMessage()">發送</button>
        </div>
        <div>
            <h3>API 測試：</h3>
            <button onclick="loadMessages()">載入歷史訊息</button>
            <button onclick="getOnlineUsers()">取得線上用戶</button>
            <button onclick="toggleDebug()">切換除錯模式</button>
        </div>
    </div>

    <script>
        const ws = new WebSocket('ws://localhost:8080/ws?username=測試用戶');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const statusDiv = document.getElementById('status');
        const debugDiv = document.getElementById('debug');
        const sendButton = document.getElementById('sendButton');

        // 除錯模式
        let debugMode = false;

        function toggleDebug() {
            debugMode = !debugMode;
            debugDiv.style.display = debugMode ? 'block' : 'none';
            showDebug('除錯模式: ' + (debugMode ? '開啟' : '關閉'));
        }

        function showDebug(message) {
            if (debugMode) {
                const timestamp = new Date().toLocaleTimeString();
                debugDiv.innerHTML += `[${timestamp}] ${message}<br>`;
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }

        // WebSocket 連接狀態處理
        ws.onopen = function() {
            showStatus('WebSocket 已連接', 'success');
            showDebug('WebSocket 連接已建立');
        };

        ws.onclose = function() {
            showStatus('WebSocket 連接已關閉', 'error');
            showDebug('WebSocket 連接已關閉');
        };

        ws.onerror = function(error) {
            showStatus('WebSocket 連接錯誤', 'error');
            showDebug('WebSocket 錯誤: ' + error);
        };

        // 處理 WebSocket 訊息
        ws.onmessage = function(event) {
            showDebug('收到 WebSocket 訊息: ' + event.data);
            const message = JSON.parse(event.data);
            addMessageToUI(message, 'websocket');
        };

        // 發送訊息函數
        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content) return;

            // 禁用發送按鈕並顯示載入狀態
            sendButton.disabled = true;
            sendButton.textContent = '發送中...';
            showStatus('正在發送訊息...', 'loading');
            showDebug('開始發送訊息: ' + content);

            // 清空輸入框
            messageInput.value = '';

            // 發送到伺服器
            const requestBody = JSON.stringify({ content: content });
            showDebug('請求內容: ' + requestBody);

            fetch('/api/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: requestBody
            })
            .then(response => {
                showDebug('收到回應，狀態碼: ' + response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.text(); // 先讀取為文字
            })
            .then(text => {
                showDebug('回應內容: ' + text);
                try {
                    const data = JSON.parse(text);
                    if (data.status === 'sent') {
                        showStatus('✅ 訊息發送成功！後端已確認接收', 'success');
                        showDebug('API 回應成功: ' + JSON.stringify(data));
                        // 發送成功後重新載入訊息以顯示最新內容
                        loadMessages();
                    } else {
                        showStatus('❌ 後端回應異常: ' + JSON.stringify(data), 'error');
                        showDebug('API 回應異常: ' + JSON.stringify(data));
                    }
                } catch (e) {
                    showStatus('❌ 回應解析失敗: ' + text, 'error');
                    showDebug('JSON 解析錯誤: ' + e.message + ', 原始回應: ' + text);
                }
            })
            .catch(error => {
                showStatus('❌ 發送失敗: ' + error.message, 'error');
                showDebug('發送錯誤: ' + error.message);
                console.error('發送錯誤:', error);
            })
            .finally(() => {
                // 恢復發送按鈕
                sendButton.disabled = false;
                sendButton.textContent = '發送';
            });
        }

        // 載入歷史訊息
        function loadMessages() {
            showDebug('開始載入歷史訊息');
            fetch('/api/messages')
                .then(response => {
                    showDebug('載入訊息回應，狀態碼: ' + response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(text => {
                    showDebug('載入訊息回應內容: ' + text);
                    const messages = JSON.parse(text);
                    messagesDiv.innerHTML = '';
                    messages.forEach(msg => {
                        addMessageToUI(msg, 'history');
                    });
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    showStatus(`✅ 已載入 ${messages.length} 條歷史訊息`, 'success');
                    showDebug('成功載入 ' + messages.length + ' 條訊息');
                })
                .catch(error => {
                    showStatus('❌ 載入訊息失敗: ' + error.message, 'error');
                    showDebug('載入錯誤: ' + error.message);
                    console.error('載入錯誤:', error);
                });
        }

        // 取得線上用戶
        function getOnlineUsers() {
            showDebug('開始查詢線上用戶');
            fetch('/api/users')
                .then(response => {
                    showDebug('用戶查詢回應，狀態碼: ' + response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(text => {
                    showDebug('用戶查詢回應內容: ' + text);
                    const data = JSON.parse(text);
                    showStatus(`✅ 線上用戶: ${data.users.join(', ')} (共 ${data.count} 人)`, 'success');
                    showDebug('線上用戶: ' + JSON.stringify(data));
                })
                .catch(error => {
                    showStatus('❌ 取得用戶失敗: ' + error.message, 'error');
                    showDebug('用戶查詢錯誤: ' + error.message);
                    console.error('用戶查詢錯誤:', error);
                });
        }

        // 添加訊息到 UI
        function addMessageToUI(message, source) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${message.type || ''}`;
            
            const time = new Date(message.timestamp).toLocaleTimeString();
            const sourceLabel = source === 'websocket' ? '[WebSocket]' : 
                               source === 'api' ? '[API]' : 
                               source === 'history' ? '[歷史]' : '';
            
            messageElement.innerHTML = `
                <strong>${message.user}:</strong> ${message.content}
                <small style="color: #666; margin-left: 10px;">${time} ${sourceLabel}</small>
            `;
            
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            showDebug(`添加訊息到 UI: ${message.user} - ${message.content} (來源: ${source})`);
        }

        // 顯示狀態訊息
        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            // 5秒後隱藏狀態訊息（成功訊息顯示久一點）
            const timeout = type === 'success' ? 5000 : 3000;
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, timeout);
        }

        // 鍵盤事件處理
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !sendButton.disabled) {
                sendMessage();
            }
        });

        // 頁面載入時自動載入歷史訊息
        window.onload = function() {
            loadMessages();
        };
    </script>
</body>
</html>